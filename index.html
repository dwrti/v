<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Sync</title>
    <style>
        body { background: #000; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .container { width: 100%; max-width: 900px; }
        video { width: 100%; border: 2px solid #333; }
    </style>
</head>
<body>

<div class="container">
    <video id="player" controls playsinline></video>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAjTD-OJBUYewp5bqV0iVh4Rxp5zjBsU54",
        authDomain: "videos-5e336.firebaseapp.com",
        databaseURL: "https://videos-5e336-default-rtdb.firebaseio.com",
        projectId: "videos-5e336",
        storageBucket: "videos-5e336.firebasestorage.app",
        messagingSenderId: "300218651134",
        appId: "1:300218651134:web:4bd24df8e555e62828f0af"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const videoRef = ref(db, 'sharedVideo');
    const video = document.getElementById('player');
    
    let isRemoteUpdate = false;

    // استقبال البيانات من فيربيز
    onValue(videoRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        isRemoteUpdate = true;

        // 1. تحديث الرابط (أهم شيء)
        if (data.url && video.src !== data.url) {
            video.src = data.url;
        }

        // 2. مزامنة الوقت
        if (Math.abs(video.currentTime - data.time) > 2) {
            video.currentTime = data.time;
        }

        // 3. مزامنة الحالة
        if (data.status === "playing" && video.paused) {
            video.play().catch(() => {});
        } else if (data.status === "paused" && !video.paused) {
            video.pause();
        }

        setTimeout(() => { isRemoteUpdate = false; }, 800);
    });

    // إرسال الأوامر عند اللمس أو التحكم
    video.onplay = () => {
        if (!isRemoteUpdate) update(videoRef, { status: "playing", time: video.currentTime });
    };

    video.onpause = () => {
        if (!isRemoteUpdate) update(videoRef, { status: "paused", time: video.currentTime });
    };

    video.onseeked = () => {
        if (!isRemoteUpdate) update(videoRef, { time: video.currentTime });
    };
</script>

</body>
</html>
