<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamSync Pro | المشاهدة الجماعية والدردشة</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #e50914;
            --bg-color: #0b0c10;
            --card-bg: #1f2833;
            --text-main: #ffffff;
            --text-dim: #c5c6c7;
            --accent: #66fcf1;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
        }

        /* تخطيط الصفحة الرئيسي */
        .main-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
            height: calc(100vh - 40px);
        }

        /* منطقة الفيديو */
        .video-container {
            flex: 3;
            min-width: 350px;
            display: flex;
            flex-direction: column;
        }

        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #444;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        video { width: 100%; aspect-ratio: 16/9; display: block; }

        /* منطقة الدردشة */
        .chat-container {
            flex: 1;
            min-width: 300px;
            background: var(--card-bg);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            border: 1px solid #444;
            max-height: 85vh;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #444;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        #chatMessages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-size: 14px;
        }

        .msg { margin-bottom: 10px; line-height: 1.4; }
        .msg b { color: var(--accent); }
        .msg.system { color: #888; font-style: italic; font-size: 12px; }

        .chat-input {
            padding: 10px;
            display: flex;
            gap: 5px;
            border-top: 1px solid #444;
        }

        /* أدوات الإدارة */
        .admin-panel {
            margin-top: 15px;
            background: #161b22;
            padding: 15px;
            border-radius: 10px;
            border: 1px dashed var(--primary-color);
        }

        .hidden { display: none !important; }

        /* أزرار ومدخلات */
        input {
            background: #0b0c10;
            border: 1px solid #444;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            outline: none;
        }

        button {
            cursor: pointer;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        .stats { font-size: 12px; color: var(--accent); margin-top: 5px; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="video-container">
        <div class="video-wrapper">
            <video id="myPlayer" controls playsinline></video>
        </div>
        
        <div class="stats">
            <span id="viewCount"><i class="fas fa-eye"></i> جاري الحساب...</span> | 
            <span id="syncStatus">متصل</span>
        </div>

        <div id="loginArea" style="margin-top:10px;">
            <input type="password" id="adminPass" placeholder="كلمة سر الإدارة">
            <button onclick="checkAdmin()">دخول المسؤول</button>
        </div>

        <div id="adminControls" class="admin-panel hidden">
            <div style="margin-bottom:10px; color: var(--primary-color); font-weight:bold;">لوحة التحكم بالبث</div>
            <input type="text" id="newVideoUrl" placeholder="رابط MP4 أو M3U8" style="width:70%">
            <button onclick="updateVideo()">تحديث الرابط</button>
            <button onclick="forceSyncAll()" style="background:#444">مزامنة إجبارية</button>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <span>الدردشة المباشرة</span>
            <i class="fas fa-comments"></i>
        </div>
        <div id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="userName" placeholder="اسمك" style="width:60px">
            <input type="text" id="chatMsg" placeholder="اكتب رسالة..." style="flex:1">
            <button onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script>
    // 1. Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAjTD-OJBUYewp5bqV0iVh4Rxp5zjBsU54",
        authDomain: "videos-5e336.firebaseapp.com",
        databaseURL: "https://videos-5e336-default-rtdb.firebaseio.com",
        projectId: "videos-5e336",
        storageBucket: "videos-5e336.firebasestorage.app",
        messagingSenderId: "300218651134",
        appId: "1:300218651134:web:4bd24df8e555e62828f0af"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const videoRef = db.ref('sharedVideo');
    const chatRef = db.ref('chat').limitToLast(50);
    const presenceRef = db.ref('presence');
    
    const player = document.getElementById('myPlayer');
    let hls = new Hls();
    let isAdmin = false;

    // --- نظام المشاهدين اللحظي ---
    const myPresence = presenceRef.push();
    myPresence.onDisconnect().remove();
    myPresence.set(true);

    presenceRef.on('value', snap => {
        document.getElementById('viewCount').innerHTML = `<i class="fas fa-eye"></i> مشاهدات الآن: ${snap.numChildren()}`;
    });

    // --- نظام الفيديو والمزامنة ---
    function loadVideo(url) {
        if (!url) return;
        if (url.includes('m3u8')) {
            if (Hls.isSupported()) {
                hls.destroy(); hls = new Hls();
                hls.loadSource(url); hls.attachMedia(player);
            }
        } else {
            player.src = url;
        }
    }

    videoRef.on('value', snap => {
        const data = snap.val();
        if (!data) return;

        if (player.dataset.src !== data.url) {
            player.dataset.src = data.url;
            loadVideo(data.url);
        }

        if (!isAdmin) {
            if (data.paused && !player.paused) player.pause();
            if (!data.paused && player.paused) player.play().catch(()=>{});
            if (Math.abs(player.currentTime - data.time) > 1.5) {
                player.currentTime = data.time;
            }
        }
    });

    function broadcast() {
        if (isAdmin) {
            videoRef.update({
                time: player.currentTime,
                paused: player.paused,
                lastUpdate: Date.now()
            });
        }
    }

    player.onplay = player.onpause = player.onseeking = broadcast;
    setInterval(() => { if(isAdmin && !player.paused) broadcast(); }, 2000);

    // --- نظام الدردشة ---
    function sendChat() {
        const name = document.getElementById('userName').value || "مجهول";
        const text = document.getElementById('chatMsg').value;
        if (!text) return;
        chatRef.parent.child('chat').push({ name, text, time: Date.now() });
        document.getElementById('chatMsg').value = "";
    }

    chatRef.on('child_added', snap => {
        const msg = snap.val();
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<b>${msg.name}:</b> ${msg.text}`;
        const container = document.getElementById('chatMessages');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    });

    // --- وظائف المسؤول ---
    function checkAdmin() {
        if (document.getElementById('adminPass').value === "1234") {
            isAdmin = true;
            document.getElementById('loginArea').classList.add('hidden');
            document.getElementById('adminControls').classList.remove('hidden');
            chatRef.parent.child('chat').push({ name: "النظام", text: "دخل المسؤول إلى الغرفة", type: "system" });
        }
    }

    function updateVideo() {
        const url = document.getElementById('newVideoUrl').value;
        if (url) videoRef.set({ url, time: 0, paused: false });
    }

    function forceSyncAll() {
        if (isAdmin) broadcast();
    }
</script>
</body>
</html>
