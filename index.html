<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مشغل فيديو متزامن</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f4f9;
        }
        .video-container {
            width: 100%;
            max-width: 600px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        video {
            width: 100%;
            display: block;
        }
        .controls-area {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        input[type="text"] {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            padding: 12px;
            background-color: #25d366;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #status { font-size: 12px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="video-container">
        <video id="myPlayer" controls poster="https://via.placeholder.com/600x340?text=Waiting+for+Video">
            Your browser does not support the video tag.
        </video>
    </div>

    <div class="controls-area">
        <input type="text" id="videoUrl" placeholder="أضف رابط الفيديو هنا...">
        <button id="loadBtn">تحديث الفيديو للجميع</button>
        <p id="status">المزامنة متصلة بـ Firebase...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // إعدادات Firebase الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyAjTD-OJBUYewp5bqV0iVh4Rxp5zjBsU54",
            authDomain: "videos-5e336.firebaseapp.com",
            databaseURL: "https://videos-5e336-default-rtdb.firebaseio.com",
            projectId: "videos-5e336",
            storageBucket: "videos-5e336.firebasestorage.app",
            messagingSenderId: "300218651134",
            appId: "1:300218651134:web:4bd24df8e555e62828f0af"
        };

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const videoRef = ref(db, 'videoState');

        const player = document.getElementById('myPlayer');
        const videoUrlInput = document.getElementById('videoUrl');
        const loadBtn = document.getElementById('loadBtn');

        let isUpdating = false; // لمنع حدوث حلقة تكرارية (Loop)

        // 1. إرسال البيانات لقاعدة البيانات عند حدوث تغيير
        function updateFirebase() {
            if (isUpdating) return;
            set(videoRef, {
                url: player.src,
                currentTime: player.currentTime,
                paused: player.paused,
                timestamp: Date.now()
            });
        }

        // عند تغيير الرابط
        loadBtn.onclick = () => {
            const url = videoUrlInput.value;
            if (url) {
                set(videoRef, {
                    url: url,
                    currentTime: 0,
                    paused: false,
                    timestamp: Date.now()
                });
            }
        };

        // أحداث المشغل
        player.onplay = updateFirebase;
        player.onpause = updateFirebase;
        player.onseeked = updateFirebase;

        // 2. الاستماع للتغييرات من Firebase وتطبيقها عند الجميع
        onValue(videoRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            isUpdating = true; // إيقاف الإرسال مؤقتاً لتجنب التعليق

            // تحديث الرابط إذا تغير
            if (player.src !== data.url && data.url !== "") {
                player.src = data.url;
            }

            // تحديث الوقت إذا كان الفرق أكثر من ثانية (لضمان السلاسة)
            if (Math.abs(player.currentTime - data.currentTime) > 1.5) {
                player.currentTime = data.currentTime;
            }

            // تشغيل أو إيقاف
            if (data.paused && !player.paused) {
                player.pause();
            } else if (!data.paused && player.paused) {
                player.play().catch(() => {
                    console.log("التشغيل التلقائي محظور حتى يتفاعل المستخدم مع الصفحة");
                });
            }

            isUpdating = false;
        });
    </script>
</body>
</html>
